{% extends 'APP/base.html' %}

{% block title %}Agenda Fármaco - Transbirday{% endblock %}

{% block extra_head %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.ckeditor.com/4.16.0/standard/ckeditor.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Fármaco - Agenda (Eventos/Treinamentos)</h2>
        {% if perms.APP.add_agendafarmaco %}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agendaModal" id="btnNovoEvento">
            + Adicionar Novo Evento/Treinamento
        </button>
        {% endif %}
    </div>

    <div class="row">
        
        <div class="col-lg-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4>Treinamentos</h4>
                {% if show_filter == 'future' %}
                    <a href="?show=all" class="btn btn-outline-secondary btn-sm">Mostrar Encerrados</a>
                {% else %}
                    <a href="?show=future" class="btn btn-outline-secondary btn-sm">Mostrar Próximos</a>
                {% endif %}
            </div>
            
            <div class="list-group" id="treinamentosAccordion">
                {% load tz %}
                {% for evento in treinamentos %}
                <div class="mb-3 rounded overflow-hidden">
                    {% comment %} Verifica se o evento já passou {% endcomment %}
                    {% now "Y-m-d" as hoje %}
                    {% if evento.data_evento|date:"Y-m-d" < hoje %}
                        <a href="#evento-details-{{ evento.id }}" class="list-group-item list-group-item-action list-group-item-danger" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="evento-details-{{ evento.id }}">
                    {% else %}
                        <a href="#evento-details-{{ evento.id }}" class="list-group-item list-group-item-action list-group-item-info" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="evento-details-{{ evento.id }}">
                    {% endif %}
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ evento.assunto }}</h5>
                            <small>Data: {{ evento.data_evento|date:"d/m/Y" }}</small>
                        </div>
                        <p class="mb-1">Tipo: {{ evento.get_tipo_display }}</p>
                    </a>
                    <div class="collapse" id="evento-details-{{ evento.id }}" data-bs-parent="#treinamentosAccordion">
                        <div class="card card-body" style="border-top: none; border-radius: 0;">
                            <ul class="list-unstyled mb-3">
                                <li><strong>Hora do Evento:</strong> {{ evento.hora_evento|time:"H:i" }}</li>
                                <li><strong>Responsável pelo Cadastro:</strong> {{ evento.responsavel_cadastro.username|default:"N/A" }}</li>
                            </ul>
                            {% if evento.detalhes %}
                            <h6 class="card-title">Detalhes</h6>
                            <div class="p-2 bg-light rounded mb-3">{{ evento.detalhes|safe }}</div>
                            {% endif %}
                            <hr>
                            <div>
                                {% if perms.APP.change_agendafarmaco %}
                                <button type="button" class="btn btn-secondary btn-sm edit-btn"
                                        data-bs-toggle="modal" data-bs-target="#agendaModal"
                                        data-id="{{ evento.id }}">
                                    Editar
                                </button>
                                {% endif %}
                                {% if perms.APP.delete_agendafarmaco %}
                                <button type="button" class="btn btn-danger btn-sm delete-btn"
                                        data-bs-toggle="modal" data-bs-target="#deleteModal"
                                        data-id="{{ evento.id }}"
                                        data-nome="{{ evento.assunto }}">
                                    Excluir
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info" role="alert">
                    Nenhum treinamento encontrado.
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-lg-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4>Eventos</h4>
                {% if show_filter == 'future' %}
                    <a href="?show=all" class="btn btn-outline-secondary btn-sm">Mostrar Encerrados</a>
                {% else %}
                    <a href="?show=future" class="btn btn-outline-secondary btn-sm">Mostrar Próximos</a>
                {% endif %}
            </div>

            <div class="list-group" id="eventosAccordion">
                {% for evento in eventos %}
                <div class="mb-3 rounded overflow-hidden">
                    {% comment %} Verifica se o evento já passou {% endcomment %}
                    {% now "Y-m-d" as hoje %}
                    {% if evento.data_evento|date:"Y-m-d" < hoje %}
                        <a href="#evento-details-{{ evento.id }}" class="list-group-item list-group-item-action list-group-item-danger" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="evento-details-{{ evento.id }}">
                    {% else %}
                        <a href="#evento-details-{{ evento.id }}" class="list-group-item list-group-item-action list-group-item-secondary" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="evento-details-{{ evento.id }}">
                    {% endif %}
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ evento.assunto }}</h5>
                            <small>Data: {{ evento.data_evento|date:"d/m/Y" }}</small>
                        </div>
                        <p class="mb-1">Tipo: {{ evento.get_tipo_display }}</p>
                    </a>
                    <div class="collapse" id="evento-details-{{ evento.id }}" data-bs-parent="#eventosAccordion">
                        <div class="card card-body" style="border-top: none; border-radius: 0;">
                            <ul class="list-unstyled mb-3">
                                <li><strong>Hora do Evento:</strong> {{ evento.hora_evento|time:"H:i" }}</li>
                                <li><strong>Responsável pelo Cadastro:</strong> {{ evento.responsavel_cadastro.username|default:"N/A" }}</li>
                            </ul>
                            {% if evento.detalhes %}
                            <h6 class="card-title">Detalhes</h6>
                            <div class="p-2 bg-light rounded mb-3">{{ evento.detalhes|safe }}</div>
                            {% endif %}
                            <hr>
                            <div>
                                {% if perms.APP.change_agendafarmaco %}
                                <button type="button" class="btn btn-secondary btn-sm edit-btn"
                                        data-bs-toggle="modal" data-bs-target="#agendaModal"
                                        data-id="{{ evento.id }}">
                                    Editar
                                </button>
                                {% endif %}
                                {% if perms.APP.delete_agendafarmaco %}
                                <button type="button" class="btn btn-danger btn-sm delete-btn"
                                        data-bs-toggle="modal" data-bs-target="#deleteModal"
                                        data-id="{{ evento.id }}"
                                        data-nome="{{ evento.assunto }}">
                                    Excluir
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info" role="alert">
                    Nenhum evento encontrado.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="agendaModal" tabindex="-1" aria-labelledby="agendaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="agendaModalLabel">Adicionar Evento/Treinamento</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>
</div>

<div id="create-form-template" class="d-none">
    <form id="agendaForm" action="{% url 'agenda_farmaco_list' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ agenda_form.as_p }}
        <div class="modal-footer mt-3">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
    </form>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="deleteModalLabel">Confirmar Exclusão</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir <strong id="eventoNomeDelete"></strong>?</p>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Usando jQuery
$(document).ready(function() {
    const modal = new bootstrap.Modal(document.getElementById('agendaModal'));
    const modalLabel = $('#agendaModalLabel');
    const modalBody = $('#agendaModal .modal-body');
    const editorId = 'id_detalhes'; // ID do campo CKEditor

    // Abrir modal para CRIAÇÃO
    $('#btnNovoEvento').on('click', function() {
        modalLabel.text('Adicionar Novo Evento/Treinamento');
        const createFormHtml = $('#create-form-template').html();
        modalBody.html(createFormHtml);
        if(typeof CKEDITOR !== 'undefined') {
             CKEDITOR.replace(editorId);
        }
        modal.show();
    });

    // Abrir modal para EDIÇÃO
    $('.edit-btn').on('click', function() {
        const eventoId = $(this).data('id');
        const url = `/farmaco/agenda/${eventoId}/edit-form/`;
        modalLabel.text('Editar Evento/Treinamento');
        
        fetch(url)
            .then(response => response.text())
            .then(html => {
                modalBody.html(html);
                if(typeof CKEDITOR !== 'undefined' && CKEDITOR.instances[editorId]) {
                    CKEDITOR.instances[editorId].destroy(true);
                }
                CKEDITOR.replace(editorId); 
                modal.show();
            });
    });

    // Limpar CKEditor ao fechar o modal
    $('#agendaModal').on('hidden.bs.modal', function () {
        if (CKEDITOR.instances[editorId]) {
            CKEDITOR.instances[editorId].destroy(true);
        }
        modalBody.html('');
    });

    // --- Lógica para o Modal de Exclusão ---
    const deleteForm = document.getElementById('deleteForm');
    const eventoNomeDelete = document.getElementById('eventoNomeDelete');
    
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const eventoId = this.dataset.id;
            deleteForm.action = `/farmaco/agenda/${eventoId}/delete/`;
            eventoNomeDelete.textContent = this.dataset.nome;
        });
    });
});
</script>
{% endblock %}