{% extends 'APP/base.html' %}

{% block title %}Lista de PGRs - Transbirday{% endblock %}

{% block extra_head %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>GR - Planos de Gerenciamento de Risco (PGRs)</h2>
    {% if perms.APP.add_pgr %}
    <button type="button" id="btnNovoPGR" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#pgrModal">
        + Novo PGR
    </button>
    {% endif %}
</div>
<div class="list-group" id="pgrAccordion">
    {% for pgr in pgrs %}
    <div class="mb-3 rounded overflow-hidden">
        <a href="#pgr-details-{{ pgr.id }}" class="list-group-item list-group-item-action {{ pgr.bg_color }}" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="pgr-details-{{ pgr.id }}">
            <div class="d-flex w-100 justify-content-between"> <h5 class="mb-1">{{ pgr.titulo_cliente }}</h5> <small>Validade: {{ pgr.validade|date:"d/m/Y" }}</small> </div>
            <p class="mb-1">Tipo de Seguro: {{ pgr.tipo_seguro }}</p>
        </a>
        <div class="collapse" id="pgr-details-{{ pgr.id }}" data-bs-parent="#pgrAccordion">
            <div class="card card-body" style="border-top: none; border-radius: 0;">
                <ul class="list-unstyled mb-3">
                    {% if pgr.gerente_conta %}<li><strong>Gerente de Conta:</strong> {{ pgr.gerente_conta }}</li>{% endif %}
                    {% if pgr.contato_gc %}<li><strong>Telefone do GC:</strong> {{ pgr.contato_gc }}</li>{% endif %}
                    {% if pgr.email_gc %}<li><strong>E-mail do GC:</strong> {{ pgr.email_gc }}</li>{% endif %}
                    <li> <strong>Arquivo PDF:</strong> {% if pgr.arquivo_pdf %}{% if perms.APP.view_gr_attachments %}<a href="{% url 'serve_pgr_file' pgr.pk %}" target="_blank"><i class="bi bi-file-pdf"></i> Visualizar PDF</a>{% endif %}{% else %}Nenhum arquivo enviado.{% endif %} </li>
                </ul>
                {% if pgr.regras_embarque.all %}
                <hr>
                <h5 class="card-title mb-3">Regras de Embarque:</h5>
                {% for regra in pgr.regras_embarque.all %}
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h6 class="card-title fw-bold">{{ regra.titulo }}</h6>
                        <div class="card-text">{{ regra.descricao|safe }}</div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
                <div class="mt-3">
                    {% if perms.APP.change_pgr %}
                    <button type="button" class="btn btn-secondary btn-sm align-self-start edit-pgr-btn" data-id="{{ pgr.id }}" data-bs-toggle="modal" data-bs-target="#pgrModal"> Editar PGR </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="alert alert-info" role="alert"> Nenhum PGR cadastrado até o momento. </div>
    {% endfor %}
</div>

<div class="modal fade" id="pgrModal" tabindex="-1" aria-labelledby="pgrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="pgrModalLabel"></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                </div>
        </div>
    </div>
</div>

<div id="create-form-template" class="d-none">
    <form id="pgrForm" action="{% url 'pgr_list' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ pgr_form.as_p }}
        <hr>
        <h4 class="mb-3">Regras de Embarque</h4>
        {{ regra_formset.management_form }}
        <div id="regras-container">
            {% for form in regra_formset %}
                <div class="regra-form mb-3 p-3 border rounded">
                    <div class="mb-2">
                        <label for="{{ form.titulo.id_for_label }}" class="form-label fw-bold fs-5 mb-1">{{ form.titulo.label }}</label>
                        {{ form.titulo }}
                    </div>
                    <div class="mb-2">
                        <label for="{{ form.descricao.id_for_label }}" class="form-label">{{ form.descricao.label }}</label>
                        {{ form.descricao }}
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="empty-form" class="d-none">
            <div class="regra-form mb-3 p-3 border rounded">
                <div class="mb-2">
                    <label for="{{ regra_formset.empty_form.titulo.id_for_label }}" class="form-label fw-bold fs-5 mb-1">{{ regra_formset.empty_form.titulo.label }}</label>
                    {{ regra_formset.empty_form.titulo }}
                </div>
                <div class="mb-2">
                    <label for="{{ regra_formset.empty_form.descricao.id_for_label }}" class="form-label">{{ regra_formset.empty_form.descricao.label }}</label>
                    {{ regra_formset.empty_form.descricao }}
                </div>
            </div>
        </div>
        <button type="button" id="add-regra-btn" class="btn btn-outline-success btn-sm mt-2">+ Nova Regra de Embarque</button>
        <div class="modal-footer mt-4">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="submit" class="btn btn-primary">Salvar Novo PGR</button>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
// Usando jQuery, que foi carregado no extra_head
$(document).ready(function() {
    const modal = new bootstrap.Modal(document.getElementById('pgrModal'));
    const modalLabel = $('#pgrModalLabel');
    const modalBody = $('#pgrModal .modal-body');

    // ===================================================================
    //                       INÍCIO DA CORREÇÃO
    // ===================================================================

    // Função para inicializar todos os CKEditors visíveis
    function inicializarCKEditors(context) {
        // 'context' aqui é o objeto jQuery $modalBody. 
        // Vamos pegar o elemento DOM bruto (raw) para usar querySelectorAll.
        var domContext = context.get(0);
        
        // 1. Encontra todos os DIVs de widget
        var widgets = domContext.querySelectorAll('div.django-ckeditor-widget');

        widgets.forEach(function(widgetDiv) {
            // 2. Encontra o textarea DENTRO do div
            var textarea = widgetDiv.querySelector('textarea');
            
            if (textarea) {
                var editorId = textarea.id;
                
                // 3. Ponto crucial: NÃO inicializar o formulário "modelo" do formset
                if (editorId && editorId.indexOf('__prefix__') === -1) {
                    
                    // 4. Destrói instância anterior se existir
                    if (CKEDITOR.instances[editorId]) {
                        CKEDITOR.instances[editorId].destroy(true);
                    }
                    // 5. Cria a nova instância
                    CKEDITOR.replace(editorId);
                }
            }
        });
    }

    // Função para destruir todas as instâncias do CKEditor deste formset
    function destruirCKEditors() {
        for (const instanceName in CKEDITOR.instances) {
            // Verifica se a instância pertence a este formulário (pelo prefixo)
            if (instanceName.startsWith('id_regras-')) {
                 if (CKEDITOR.instances[instanceName]) {
                    CKEDITOR.instances[instanceName].destroy(true);
                 }
            }
        }
    }

    // Função para adicionar um novo formulário de regra
    function addRegraForm() {
        const totalForms = document.getElementById('id_regras-TOTAL_FORMS');
        let formIdx = parseInt(totalForms.value);
        
        const newFormHtml = $('#empty-form').html().replace(/__prefix__/g, formIdx);
        $('#regras-container').append(newFormHtml);
        totalForms.value = formIdx + 1;

        // Inicializa o CKEditor no novo campo
        const newTextAreaId = `id_regras-${formIdx}-descricao`;
        if(typeof CKEDITOR !== 'undefined') {
            CKEDITOR.replace(newTextAreaId);
        }
    }

    // Delegação de evento para o botão de adicionar regra
    modalBody.on('click', '#add-regra-btn', addRegraForm);

    // Abrir modal para CRIAÇÃO
    $('#btnNovoPGR').on('click', function() {
        modalLabel.text('Adicionar Novo PGR');
        const createFormHtml = $('#create-form-template').html();
        modalBody.html(createFormHtml);
        inicializarCKEditors(modalBody);
        modal.show();
    });

    // Abrir modal para EDIÇÃO
    $('.edit-pgr-btn').on('click', function() {
        const pgrId = $(this).data('id');
        const url = `/pgrs/${pgrId}/edit-form/`;
        
        modalLabel.text('Editar PGR');
        
        fetch(url)
            .then(response => response.text())
            .then(html => {
                modalBody.html(html);
                inicializarCKEditors(modalBody);
                modal.show();
            });
    });

    // Limpar CKEditor ao fechar o modal
    $('#pgrModal').on('hidden.bs.modal', function () {
        destruirCKEditors();
        modalBody.html('');
    });
    // ===================================================================
    //                         FIM DA CORREÇÃO
    // ===================================================================
});
</script>
{% endblock %}
